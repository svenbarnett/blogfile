<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><title>从Apollo动态配置原理学Spring(一) | 人间日常 | 所行皆过往，所愿皆成真</title><meta name="author" content="SIWEN.PENG"><meta name="description" content="从学习Apollo的动态配置生效原理，从而学习Spring的扩展机制"><meta name="keywords" content="Apollo,Spring,动态配置,psw,彭思文,siwen,思文,sven,java,study,solution,blog"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta property="og:title" content="从Apollo动态配置原理学Spring(一)"><meta property="og:site_name" content="人间日常"><meta property="og:image" content="/avatar.jpg"><link href="/avatar.jpg" rel="icon"><link rel="alternate" href="/atom.xml" title="人间日常" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3643487522951220" crossorigin="anonymous"></script><script type="text/javascript" src="//cpro.baidustatic.com/cpro/ui/cm.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><amp-auto-ads type="adsense" data-ad-client="ca-pub-3643487522951220"></amp-auto-ads><div class="blog"><div class="content"><header><div class="site-branding"><h1 class="site-title"><a href="/">人间日常</a></h1><p class="site-description">所行皆过往，所愿皆成真</p></div><nav class="site-navigation"><ul><li><a href="/">主页</a></li><li><a href="/archives/">归档</a></li><li><a href="/pics/">图记</a></li></ul></nav></header><main class="site-main posts-loop"><div id="container"><article><h3 class="article-title"><span>从Apollo动态配置原理学Spring(一)</span></h3><div class="article-top-meta"><span class="posted-on"><a href="/p/e352a76e/" rel="bookmark"><time class="entry-date published" datetime="2023-02-23T14:29:54.000Z">2023-02-23</time></a></span></div><div class="article-content"><div class="entry"><blockquote><p>最近工作碰到需要写一个类似携程 Apollo 的动态配置功能，以此系统学习该原理，熟练掌握下 Spring 的各种机制</p></blockquote><p><strong>Apollo 动态配置原理简述</strong></p><p>Apollo 配置中心动态生效机制，是基于 Http 长轮询请求和 Spring 扩展机制实现的，在 Spring 容器启动过程中，Apollo 通过自定义的 <code>BeanPostProcessor</code> 和 <code>BeanFactoryPostProcessor</code> 將参数中包含 <code>$&#123;…&#125;</code> 占位符和 <code>@Value</code> 注解的 Bean 注册到 Apollo 框架中定义的注册表中。然后通过 Http 长轮询不断的去获取服务端的配置信息，一旦配置发生变化，Apollo 会根据变化的配置的 Key 找到对应的 Bean，然后修改 Bean 的属性，从而实现了配置动态生效的特性。</p><p>需要注意的是，Apollo 在配置变化后，只能修改 Bean 的属性，例如我们数据源的属性发生变化，新创建的 Connection 对象是没问题的，但是连接池中已经创建的 Connection 对象相关信息是不能动态修改的，所以依然需要重启应用。</p><span id="more"></span><p>其中涉及到的 Spring 的扩展机制有：</p><ul><li>BeanFactoryPostProcessor</li><li>BeanPostProcessor</li><li>BeanDefinitionRegistry</li><li>PropertySource</li><li>ImportBeanDefinitionRegistrar</li><li>PropertySourcesPlaceholderConfigurer</li></ul><p>…</p><p>其中每一个都是非常关键的点，我们后续会一一进行学习。</p><h2 id="apollo启动过程"><a class="markdownIt-Anchor" href="#apollo启动过程">#</a> Apollo 启动过程</h2><p>首先，我们先看一张图：</p><p><img src="/images/loading.svg" data-original="/p/e352a76e/image-20230223224050610.png" alt="Apollo启动图"></p><ol><li><p>Spring 启动，扫描 bean，将相关变量参数注册到 Apollo 属性注册表</p></li><li><p>通过 RemoteConfigRepository 获取配置，持久化本地，后续读取从本地读取，通过 <code>PropertySourcesProcessor</code> 执行如下步骤</p></li></ol><p>（1）根据命名空间从配置中心获取配置信息，创建 RemoteConfigRepository 和 LocalFileConfigRepository 对象。RemoteConfigRepository 表示远程配置中心资源，LocalFileConfigRepository 表示本地缓存配置资源。</p><p>（2）LocalFileConfigRepository 对象缓存配置信息到 C:\opt\data 或者 /opt/data 目录</p><p>（3）RemoteConfigRepository 开启 HTTP 长轮询请求定时任务，默认 2s 请求一次。</p><p>（4）將本地缓存配置信息转换为 PropertySource 对象（Apollo 自定义了 Spring 的 PropertySource），加载到 Spring 的 Environment 对象中。至此静态配置就已经加入到环境变量中</p><p>（5）將自定义的 ConfigPropertySource 注册为观察者。一旦 RemoteConfigRepository 发现远程配置中心信息发生变化，ConfigPropertySource 对象会得到通知。</p><ol start="3"><li><p>通过一个自定义监听器，监听对应事件</p></li><li><p>后续通过长轮询请求监听到配置变化，根据配置读取注册表里面的 key 和对应的 bean，通过反射修改 bean 对应属性值</p></li></ol><h2 id="apollo扩展点"><a class="markdownIt-Anchor" href="#apollo扩展点">#</a> Apollo 扩展点</h2><ol><li><code>PropertySourcesProcessor</code> 初始化 Apollo 配置、接入 Spring environment，初始化 Apollo 监听器</li><li><code>ApolloAnnotationProcessor</code> 提供 Apollo 一些注解支持 <code>@ApolloConfig</code> ， <code>@ApolloConfigChangeListener</code></li><li><code>SpringValueProcessor</code> 提供对 <code>@Value</code> 动态生效能力 针对实例 bean</li><li><code>SpringValueDefinitionProcessor</code> 提供对 <code>@Value</code> 动态生效能力 针对 bean 定义</li><li><code>ApolloJsonValueProcessor</code> 提供对 <code>@ApolloJsonValue</code> 支持</li></ol><p>上述分别对应使用 Spring 的扩展能力 <code>BeanFactoryPostProcessor</code> 、 <code>BeanPostProcessor</code> 、 <code>BeanPostProcessor</code> 和 <code>BeanFactoryPostProcessor</code> 、 <code>BeanDefinitionRegistryPostProcessor</code> 、 <code>BeanPostProcessor</code></p><p>我们这个系列也会对 apollo 基于 spring 提供的扩展点来嵌入自己的能力。主要为 BeanFactoryPostProcessor、BeanPostProcessor 这两个扩展点；先简单说一下：<em><strong>只需要知道，BeanFactoryPostProcessor、BeanDefinitionRegistryPostProcessor 在生成所有 beandefinition 之后调用，而 BeanPostProcessor 在通过 beandefinition 实例化 bean 的过程中调用即可。</strong></em></p><p>那这些实现我们就下篇见了！！！</p></div></div><div class="article-footer"><div class="article-meta pull-left"><span class="post-categories"><i class="icon-categories"></i> <a href="/categories/Java/">Java</a> </span><span class="post-tags"><i class="icon-tags"></i> <a href="/tags/Apollo/">Apollo</a><a href="/tags/Spring/">Spring</a><a href="/tags/动态配置/">动态配置</a></span></div></div></article></div><link rel="stylesheet" href="/js/readmore/readmore.css" media="screen" type="text/css"><script src="/js/readmore/readmore.js" type="text/javascript"></script><script>const btw=new BTWPlugin;btw.init({id:"container",blogId:"31136-1676194002310-704",name:"浪漫宇宙与人间日常",qrcode:"/qrcode.jpg",keyword:"人间日常"})</script></main><footer class="site-footer"><p class="mp"><img alt="关注我" src="/mp.png" style="border-radius:10px" no-lazy></p><p class="site-info">湘ICP备2020021380号-1<br>&copy; 2014 - 2023 SIWEN.PENG</p></footer><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?83fbb968d837cac86cb15c97ddd8cdd4",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script></div></div><style>[bg-lazy]{background-image:none!important;background-color:#eee!important}</style><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var a=/\.(gif|jpg|jpeg|tiff|png)$/i,e=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(t){var r=t.parentNode;"A"===r.tagName&&(r.href.match(a)||r.href.match(e))&&(r.href=t.dataset.original)})})</script><script>!function(t){function e(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function n(){i&&(r=e());for(var n,a=0;a<r.length;a++)0<=(n=(n=r[a]).getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(t.innerHeight*o||document.documentElement.clientHeight*o)&&function(){var e,n,i,o=r[a],c=function(){r=r.filter(function(t){return o!==t}),t.imageLazyLoadSetting.onImageLoaded&&t.imageLazyLoadSetting.onImageLoaded(o)};(e=o).hasAttribute("bg-lazy")?(e.removeAttribute("bg-lazy"),c()):(n=new Image,i=e.getAttribute("data-original"),n.onload=function(){e.src=i,e.removeAttribute("data-original"),c()},e.src!==i&&(n.src=i))}()}function a(){clearTimeout(n.tId),n.tId=setTimeout(n,500)}t.imageLazyLoadSetting.processImages=n;var i=t.imageLazyLoadSetting.isSPA,o=t.imageLazyLoadSetting.preloadRatio||1,r=e();n(),document.addEventListener("scroll",a),t.addEventListener("resize",a),t.addEventListener("orientationchange",a)}(this)</script></body></html>
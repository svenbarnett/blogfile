{"name":"acmesh","postlist":[{"title":"linux生产免费的域名证书","slug":"acmesh-cert","date":"2021-12-29T13:59:07.000Z","updated":"2023-02-14T13:19:55.026Z","comments":null,"realpath":null,"path":"api/articles/acmesh-cert.json","excerpt":"简单来说 acme.sh 实现了 acme 协议，可以从 let‘s encrypt 生成免费的证书。<br>acme.sh 有以下特点：<br>一个纯粹用 Shell（Unix shell）语言编写的 ACME 协议客户端。<br>完整的 ACME 协议实施。 支持 ACME v1 和 ACME v2 支持 ACME v2 通配符证书<br>简单，功能强大且易于使用。你只需要 3 分钟就可以学习它。<br>Let’s Encrypt 免费证书客户端最简单的 shell 脚本。<br>纯粹用 Shell 编写，不依赖于 python 或官方的 Let’s Encrypt 客户端。<br>只需一个脚本即可自动颁发，续订和安装证书。 不需要 root/sudoer 访问权限。<br>支持在 Docker 内使用，支持 IPv6","keywords":"linux,cert,acme.sh","cover":"/p/4425fc35/867078-20190326175923357-720763416.png","content":"<p><a href=\"http://xn--acme-kt0gs67hmo3a2r1a.sh\">简单来说 acme.sh</a> 实现了 acme 协议，可以从 let‘s encrypt 生成免费的证书。<br>\n<a href=\"http://acme.sh\">acme.sh</a> 有以下特点：<br>\n一个纯粹用 Shell（Unix shell）语言编写的 ACME 协议客户端。<br>\n完整的 ACME 协议实施。 支持 ACME v1 和 ACME v2 支持 ACME v2 通配符证书<br>\n简单，功能强大且易于使用。你只需要 3 分钟就可以学习它。<br>\nLet’s Encrypt 免费证书客户端最简单的 shell 脚本。<br>\n纯粹用 Shell 编写，不依赖于 python 或官方的 Let’s Encrypt 客户端。<br>\n只需一个脚本即可自动颁发，续订和安装证书。 不需要 root/sudoer 访问权限。<br>\n支持在 Docker 内使用，支持 IPv6</p>\n<span id=\"more\"></span>\n<p><strong>安装环境：</strong><br>\n<strong>操作系统：centos 7 X64</strong><br>\n<strong>SSL 证书来源：Let’s Encrypt</strong><br>\n<strong> 安装用脚本：<a href=\"http://acme.sh\">acme.sh</a></strong><br>\n<strong> 服务器：nginx</strong><br>\n<strong> 域名：<a href=\"http://epoint.pswen.cn\">epoint.pswen.cn</a></strong></p>\n<p><a href=\"http://1.xn--acme-ke9g492u.sh\">1. 安装 acme.sh</a></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://get.acme.sh | sh</span><br></pre></td></tr></table></figure>\n<p>2. 安装后的配置<br>\n把 <a href=\"http://acme.sh\">acme.sh</a> 安装到你的 home 目录下:~/.acme.sh/ 并创建 一个 bash 的 alias, 方便你的使用:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alias acme.sh=~/.acme.sh/acme.sh</span><br><span class=\"line\">echo &#x27;alias acme.sh=~/.acme.sh/acme.sh&#x27; &gt;&gt;/etc/profile</span><br></pre></td></tr></table></figure>\n<p>3. 申请证书<br>\n<a href=\"http://acme.sh\"> acme.sh</a> 实现了 acme 协议支持的所有验证协议。一般有两种方式验证: http 和 dns 验证（本文不提供 dns 方式申请，dns 手动模式，不能自动更新证书。在续订证书时，您必须手动向域中添加新的 txt 记录。）</p>\n<p>HTTP 方式方法如下：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --issue -d epoint.pswen.cn --webroot /nginx网站根目录</span><br></pre></td></tr></table></figure>\n<p>只需要指定域名，并指定域名所在的网站根目录【命令中根目录路径】. <a href=\"http://acme.sh\">acme.sh</a> 会全自动的生成验证文件，并放到网站的根目录，然后自动完成验证。最后会聪明的删除验证文件。整个过程没有任何副作用.</p>\n<p>4. 证书的安装<br>\n注意，默认生成的证书都放在安装目录下: ~/.acme.sh/, 请不要直接使用此目录下的文件，<br>\n 例如：不要直接让 nginx/apache 的配置文件使用这下面的文件.<br>\n 这里面的文件都是内部使用，而且目录结构可能会变化.</p>\n<p>正确的使用方法是使用 --installcert 命令，并指定目标位置，然后证书文件会被 copy 到相应的位置，</p>\n<p>Nginx 服务： <code>service nginx force-reload</code> 。(centos6)</p>\n<p>Nginx 服务： <code>systemctl restart nginx </code> 。(centos7)</p>\n<p>nginx 示例 1:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --installcert -d epoint.pswen.cn --key-file /usr/local/nginx/ssl_cert/epoint.pswen.cn.key --fullchain-file /usr/local/nginx/ssl_cert/epoint.pswen.cn.cer --reloadcmd &quot;service nginx force-reload&quot;</span><br></pre></td></tr></table></figure>\n<p>nginx 示例 2：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --install-cert -d chandao.test.com \\</span><br><span class=\"line\">--key-file /usr/local/nginx/ssl_cert/test.com/chandao.test.com.key \\</span><br><span class=\"line\">--fullchain-file /usr/local/nginx/ssl_cert/test.com/chandao.test.com.cer \\</span><br><span class=\"line\">--reloadcmd      <span class=\"string\">&quot;service nginx force-reload&quot;</span></span><br></pre></td></tr></table></figure>\n<p>附带完成前面 1-4 步骤的截图：</p>\n<p><img src=\"/p/4425fc35/867078-20190326175923357-720763416.png\" alt=\"img\"></p>\n<ol start=\"5\">\n<li>Nginx 服务器安装 SSL 证书</li>\n</ol>\n<p>Nginx 配置 Http 和 Https 共存</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">listen 80; #如果硬性要求全部走https协议，这一行去除</span><br><span class=\"line\">listen 443 ssl http2; #如果硬性要求全部走https协议，这里去除ssl</span><br><span class=\"line\">server_name chandao.test.com;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">ssl on; <span class=\"comment\">#如果硬性要求全部走https协议，这里开启ssl on</span></span></span><br><span class=\"line\">ssl_certificate /usr/local/nginx/ssl_cert/test.com/chandao.test.com.cer;</span><br><span class=\"line\">ssl_certificate_key /usr/local/nginx/ssl_cert/test.com/chandao.test.com.key;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">ssl性能调优</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">nginx 1.13.0支持了TLSv1.3,TLSv1.3相比之前的TLSv1.2、TLSv1.1等性能大幅提升</span></span><br><span class=\"line\">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;</span><br><span class=\"line\">ssl_prefer_server_ciphers on;</span><br><span class=\"line\">ssl_session_timeout 10m;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">使用ssl_session_cache优化https下Nginx的性能</span></span><br><span class=\"line\">ssl_session_cache builtin:1000 shared:SSL:10m;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">OCSP Stapling 开启。OCSP是用于在线查询证书吊销情况的服务，使用OCSP Stapling能将证书有效状态的信息缓存到服务器，提高 TLS 握手速度</span></span><br><span class=\"line\">ssl_stapling on;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">OCSP Stapling 验证开启</span></span><br><span class=\"line\">ssl_stapling_verify on; </span><br></pre></td></tr></table></figure>\n<p>完整例子：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">  listen 80;  #如果硬性要求全部走https协议，这一行去除</span><br><span class=\"line\">  listen       443 ssl http2;    #如果硬性要求全部走https协议，这里去除ssl</span><br><span class=\"line\">  server_name chandao.test.com;</span><br><span class=\"line\">  access_log off;</span><br><span class=\"line\">  index index.html index.htm index.php;</span><br><span class=\"line\">  root /data/wwwroot/chandao;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">ssl on;   <span class=\"comment\">#如果硬性要求全部走https协议，这里开启ssl on</span></span></span><br><span class=\"line\">  ssl_certificate   /usr/local/nginx/ssl_cert/test.com/chandao.test.com.cer;</span><br><span class=\"line\">  ssl_certificate_key  /usr/local/nginx/ssl_cert/test.com/chandao.test.com.key;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">ssl性能调优</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">nginx 1.13.0支持了TLSv1.3,TLSv1.3相比之前的TLSv1.2、TLSv1.1等性能大幅提升</span></span><br><span class=\"line\">  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">  ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;</span><br><span class=\"line\">  ssl_prefer_server_ciphers on;</span><br><span class=\"line\">  ssl_session_timeout 10m;</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">使用ssl_session_cache优化https下Nginx的性能</span></span><br><span class=\"line\">  ssl_session_cache builtin:1000 shared:SSL:10m;</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">OCSP Stapling 开启。OCSP是用于在线查询证书吊销情况的服务，使用OCSP Stapling能将证书有效状态的信息缓存到服务器，提高 TLS 握手速度</span></span><br><span class=\"line\">  ssl_stapling on;</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">OCSP Stapling 验证开启</span></span><br><span class=\"line\">  ssl_stapling_verify on; </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">error_page 404 /404.html;</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">error_page 502 /502.html;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  location ~ [^/]\\.php(/|$) &#123;</span><br><span class=\"line\">    #fastcgi_pass remote_php_ip:9000;</span><br><span class=\"line\">    fastcgi_pass unix:/dev/shm/php-cgi.sock;</span><br><span class=\"line\">    fastcgi_index index.php;</span><br><span class=\"line\">    include fastcgi.conf;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  location ~ .*\\.(gif|jpg|jpeg|png|bmp|swf|flv|mp4|ico)$ &#123;</span><br><span class=\"line\">    expires 30d;</span><br><span class=\"line\">    access_log off;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  location ~ .*\\.(js|css)?$ &#123;</span><br><span class=\"line\">    expires 7d;</span><br><span class=\"line\">    access_log off;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  location ~ /\\.ht &#123;</span><br><span class=\"line\">    deny all;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>6. 重启 nginx<br>\n 保存退出后，通过 nginx -t 来检查配置文件是否正确，有错误的话改之即可。配置文件检测正确之后，通过 service nginx force-reload 来重载配置文件。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -t</span><br><span class=\"line\">systemctl restart nginx</span><br></pre></td></tr></table></figure>\n","raw":null,"categories":[],"tags":[{"name":"linux","path":"api/tags/linux.json"},{"name":"acmesh","path":"api/tags/acmesh.json"},{"name":"域名证书","path":"api/tags/域名证书.json"}]}]}
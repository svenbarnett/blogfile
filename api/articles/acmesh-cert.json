{"title":"linux生产免费的域名证书","slug":"acmesh-cert","date":"2021-12-29T13:59:07.000Z","updated":"2023-04-30T03:57:46.423Z","comments":true,"path":"api/articles/acmesh-cert.json","realpath":"/p/4425fc35/","excerpt":"简单来说 acme.sh 实现了 acme 协议，可以从 let‘s encrypt 生成免费的证书。<br>acme.sh 有以下特点：<br>一个纯粹用 Shell（Unix shell）语言编写的 ACME 协议客户端。<br>完整的 ACME 协议实施。 支持 ACME v1 和 ACME v2 支持 ACME v2 通配符证书<br>简单，功能强大且易于使用。你只需要 3 分钟就可以学习它。<br>Let’s Encrypt 免费证书客户端最简单的 shell 脚本。<br>纯粹用 Shell 编写，不依赖于 python 或官方的 Let’s Encrypt 客户端。<br>只需一个脚本即可自动颁发，续订和安装证书。 不需要 root/sudoer 访问权限。<br>支持在 Docker 内使用，支持 IPv6","cover":"/p/4425fc35/867078-20190326175923357-720763416.png","content":"<html><head></head><body><p><a href=\"http://xn--acme-kt0gs67hmo3a2r1a.sh\">简单来说 acme.sh</a> 实现了 acme 协议，可以从 let‘s encrypt 生成免费的证书。<br>\n<a href=\"http://acme.sh\">acme.sh</a> 有以下特点：<br>\n一个纯粹用 Shell（Unix shell）语言编写的 ACME 协议客户端。<br>\n完整的 ACME 协议实施。 支持 ACME v1 和 ACME v2 支持 ACME v2 通配符证书<br>\n简单，功能强大且易于使用。你只需要 3 分钟就可以学习它。<br>\nLet’s Encrypt 免费证书客户端最简单的 shell 脚本。<br>\n纯粹用 Shell 编写，不依赖于 python 或官方的 Let’s Encrypt 客户端。<br>\n只需一个脚本即可自动颁发，续订和安装证书。 不需要 root/sudoer 访问权限。<br>\n支持在 Docker 内使用，支持 IPv6</p>\n<span id=\"more\"></span>\n<p><strong>安装环境：</strong><br>\n<strong>操作系统：centos 7 X64</strong><br>\n<strong>SSL 证书来源：Let’s Encrypt</strong><br>\n<strong> 安装用脚本：<a href=\"http://acme.sh\">acme.sh</a></strong><br>\n<strong> 服务器：nginx</strong><br>\n<strong> 域名：<a href=\"http://epoint.pswen.cn\">epoint.pswen.cn</a></strong></p>\n<p><a href=\"http://1.xn--acme-ke9g492u.sh\">1. 安装 acme.sh</a></p>\n<div class=\"highlight-wrap\" autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"false\" data-rel=\"SHELL\"><figure class=\"iseeu highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://get.acme.sh | sh</span><br></pre></td></tr></tbody></table></figure></div>\n<p>2. 安装后的配置<br>\n把 <a href=\"http://acme.sh\">acme.sh</a> 安装到你的 home 目录下:~/.acme.sh/ 并创建 一个 bash 的 alias, 方便你的使用:</p>\n<div class=\"highlight-wrap\" autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"false\" data-rel=\"SHELL\"><figure class=\"iseeu highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alias acme.sh=~/.acme.sh/acme.sh</span><br><span class=\"line\">echo 'alias acme.sh=~/.acme.sh/acme.sh' &gt;&gt;/etc/profile</span><br></pre></td></tr></tbody></table></figure></div>\n<p>3. 申请证书<br>\n<a href=\"http://acme.sh\"> acme.sh</a> 实现了 acme 协议支持的所有验证协议。一般有两种方式验证: http 和 dns 验证（本文不提供 dns 方式申请，dns 手动模式，不能自动更新证书。在续订证书时，您必须手动向域中添加新的 txt 记录。）</p>\n<p>HTTP 方式方法如下：</p>\n<div class=\"highlight-wrap\" autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"false\" data-rel=\"SH\"><figure class=\"iseeu highlight sh\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --issue -d epoint.pswen.cn --webroot /nginx网站根目录</span><br></pre></td></tr></tbody></table></figure></div>\n<p>只需要指定域名，并指定域名所在的网站根目录【命令中根目录路径】. <a href=\"http://acme.sh\">acme.sh</a> 会全自动的生成验证文件，并放到网站的根目录，然后自动完成验证。最后会聪明的删除验证文件。整个过程没有任何副作用.</p>\n<p>4. 证书的安装<br>\n注意，默认生成的证书都放在安装目录下: ~/.acme.sh/, 请不要直接使用此目录下的文件，<br>\n 例如：不要直接让 nginx/apache 的配置文件使用这下面的文件.<br>\n 这里面的文件都是内部使用，而且目录结构可能会变化.</p>\n<p>正确的使用方法是使用 --installcert 命令，并指定目标位置，然后证书文件会被 copy 到相应的位置，</p>\n<p>Nginx 服务： <code>service nginx force-reload</code> 。(centos6)</p>\n<p>Nginx 服务： <code>systemctl restart nginx </code> 。(centos7)</p>\n<p>nginx 示例 1:</p>\n<div class=\"highlight-wrap\" autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"false\" data-rel=\"SHELL\"><figure class=\"iseeu highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --installcert -d epoint.pswen.cn --key-file /usr/local/nginx/ssl_cert/epoint.pswen.cn.key --fullchain-file /usr/local/nginx/ssl_cert/epoint.pswen.cn.cer --reloadcmd \"service nginx force-reload\"</span><br></pre></td></tr></tbody></table></figure></div>\n<p>nginx 示例 2：</p>\n<div class=\"highlight-wrap\" autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"false\" data-rel=\"SH\"><figure class=\"iseeu highlight sh\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --install-cert -d chandao.test.com \\</span><br><span class=\"line\">--key-file /usr/local/nginx/ssl_cert/test.com/chandao.test.com.key \\</span><br><span class=\"line\">--fullchain-file /usr/local/nginx/ssl_cert/test.com/chandao.test.com.cer \\</span><br><span class=\"line\">--reloadcmd      <span class=\"string\">\"service nginx force-reload\"</span></span><br></pre></td></tr></tbody></table></figure></div>\n<p>附带完成前面 1-4 步骤的截图：</p>\n<p><img src=\"/p/4425fc35/index.html867078-20190326175923357-720763416.png\" alt=\"img\"></p>\n<ol start=\"5\">\n<li>Nginx 服务器安装 SSL 证书</li>\n</ol>\n<p>Nginx 配置 Http 和 Https 共存</p>\n<div class=\"highlight-wrap\" autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"false\" data-rel=\"SHELL\"><figure class=\"iseeu highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">listen 80; #如果硬性要求全部走https协议，这一行去除</span><br><span class=\"line\">listen 443 ssl http2; #如果硬性要求全部走https协议，这里去除ssl</span><br><span class=\"line\">server_name chandao.test.com;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">ssl on; <span class=\"comment\">#如果硬性要求全部走https协议，这里开启ssl on</span></span></span><br><span class=\"line\">ssl_certificate /usr/local/nginx/ssl_cert/test.com/chandao.test.com.cer;</span><br><span class=\"line\">ssl_certificate_key /usr/local/nginx/ssl_cert/test.com/chandao.test.com.key;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">ssl性能调优</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">nginx 1.13.0支持了TLSv1.3,TLSv1.3相比之前的TLSv1.2、TLSv1.1等性能大幅提升</span></span><br><span class=\"line\">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;</span><br><span class=\"line\">ssl_prefer_server_ciphers on;</span><br><span class=\"line\">ssl_session_timeout 10m;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">使用ssl_session_cache优化https下Nginx的性能</span></span><br><span class=\"line\">ssl_session_cache builtin:1000 shared:SSL:10m;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">OCSP Stapling 开启。OCSP是用于在线查询证书吊销情况的服务，使用OCSP Stapling能将证书有效状态的信息缓存到服务器，提高 TLS 握手速度</span></span><br><span class=\"line\">ssl_stapling on;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">OCSP Stapling 验证开启</span></span><br><span class=\"line\">ssl_stapling_verify on; </span><br></pre></td></tr></tbody></table></figure></div>\n<p>完整例子：</p>\n<div class=\"highlight-wrap\" autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"false\" data-rel=\"SHELL\"><figure class=\"iseeu highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server {</span><br><span class=\"line\">  listen 80;  #如果硬性要求全部走https协议，这一行去除</span><br><span class=\"line\">  listen       443 ssl http2;    #如果硬性要求全部走https协议，这里去除ssl</span><br><span class=\"line\">  server_name chandao.test.com;</span><br><span class=\"line\">  access_log off;</span><br><span class=\"line\">  index index.html index.htm index.php;</span><br><span class=\"line\">  root /data/wwwroot/chandao;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">ssl on;   <span class=\"comment\">#如果硬性要求全部走https协议，这里开启ssl on</span></span></span><br><span class=\"line\">  ssl_certificate   /usr/local/nginx/ssl_cert/test.com/chandao.test.com.cer;</span><br><span class=\"line\">  ssl_certificate_key  /usr/local/nginx/ssl_cert/test.com/chandao.test.com.key;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">ssl性能调优</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">nginx 1.13.0支持了TLSv1.3,TLSv1.3相比之前的TLSv1.2、TLSv1.1等性能大幅提升</span></span><br><span class=\"line\">  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">  ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;</span><br><span class=\"line\">  ssl_prefer_server_ciphers on;</span><br><span class=\"line\">  ssl_session_timeout 10m;</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">使用ssl_session_cache优化https下Nginx的性能</span></span><br><span class=\"line\">  ssl_session_cache builtin:1000 shared:SSL:10m;</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">OCSP Stapling 开启。OCSP是用于在线查询证书吊销情况的服务，使用OCSP Stapling能将证书有效状态的信息缓存到服务器，提高 TLS 握手速度</span></span><br><span class=\"line\">  ssl_stapling on;</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">OCSP Stapling 验证开启</span></span><br><span class=\"line\">  ssl_stapling_verify on; </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">error_page 404 /404.html;</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">error_page 502 /502.html;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  location ~ [^/]\\.php(/|$) {</span><br><span class=\"line\">    #fastcgi_pass remote_php_ip:9000;</span><br><span class=\"line\">    fastcgi_pass unix:/dev/shm/php-cgi.sock;</span><br><span class=\"line\">    fastcgi_index index.php;</span><br><span class=\"line\">    include fastcgi.conf;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  location ~ .*\\.(gif|jpg|jpeg|png|bmp|swf|flv|mp4|ico)$ {</span><br><span class=\"line\">    expires 30d;</span><br><span class=\"line\">    access_log off;</span><br><span class=\"line\">  }</span><br><span class=\"line\">  location ~ .*\\.(js|css)?$ {</span><br><span class=\"line\">    expires 7d;</span><br><span class=\"line\">    access_log off;</span><br><span class=\"line\">  }</span><br><span class=\"line\">  location ~ /\\.ht {</span><br><span class=\"line\">    deny all;</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure></div>\n<p>6. 重启 nginx<br>\n 保存退出后，通过 nginx -t 来检查配置文件是否正确，有错误的话改之即可。配置文件检测正确之后，通过 service nginx force-reload 来重载配置文件。</p>\n<div class=\"highlight-wrap\" autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"false\" data-rel=\"SHELL\"><figure class=\"iseeu highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -t</span><br><span class=\"line\">systemctl restart nginx</span><br></pre></td></tr></tbody></table></figure></div>\n</body></html>","raw":"简单来说acme.sh 实现了 acme 协议, 可以从 let‘s encrypt 生成免费的证书。\nacme.sh 有以下特点：\n一个纯粹用Shell（Unix shell）语言编写的ACME协议客户端。\n完整的ACME协议实施。 支持ACME v1和ACME v2 支持ACME v2通配符证书\n简单，功能强大且易于使用。你只需要3分钟就可以学习它。\nLet's Encrypt免费证书客户端最简单的shell脚本。\n纯粹用Shell编写，不依赖于python或官方的Let's Encrypt客户端。\n只需一个脚本即可自动颁发，续订和安装证书。 不需要root/sudoer访问权限。\n支持在Docker内使用，支持IPv6\n\n<!-- more -->\n\n**安装环境：**\n**操作系统：centos 7 X64**\n**SSL证书来源：Let's Encrypt**\n**安装用脚本：acme.sh**\n**服务器：nginx**\n**域名：epoint.pswen.cn**\n\n1.安装acme.sh\n\n```shell\ncurl https://get.acme.sh | sh\n```\n\n2.安装后的配置\n把 acme.sh 安装到你的 home 目录下:~/.acme.sh/并创建 一个 bash 的 alias, 方便你的使用:\n\n```shell\nalias acme.sh=~/.acme.sh/acme.sh\necho 'alias acme.sh=~/.acme.sh/acme.sh' >>/etc/profile\n```\n\n3.申请证书\nacme.sh 实现了 acme 协议支持的所有验证协议. 一般有两种方式验证: http 和 dns 验证（本文不提供dns方式申请，dns手动模式，不能自动更新证书。在续订证书时，您必须手动向域中添加新的txt记录。）\n\nHTTP 方式方法如下：\n\n```sh\nacme.sh --issue -d epoint.pswen.cn --webroot /nginx网站根目录\n```\n\n只需要指定域名, 并指定域名所在的网站根目录【命令中根目录路径】. acme.sh 会全自动的生成验证文件, 并放到网站的根目录, 然后自动完成验证. 最后会聪明的删除验证文件. 整个过程没有任何副作用.\n\n4.证书的安装\n注意, 默认生成的证书都放在安装目录下: ~/.acme.sh/, 请不要直接使用此目录下的文件,\n例如: 不要直接让 nginx/apache 的配置文件使用这下面的文件.\n这里面的文件都是内部使用, 而且目录结构可能会变化.\n\n正确的使用方法是使用 --installcert 命令,并指定目标位置, 然后证书文件会被copy到相应的位置,\n\nNginx服务：`service nginx force-reload`。(centos6)\n\nNginx服务：`systemctl restart nginx `。(centos7)\n\nnginx示例1:\n\n```shell\nacme.sh --installcert -d epoint.pswen.cn --key-file /usr/local/nginx/ssl_cert/epoint.pswen.cn.key --fullchain-file /usr/local/nginx/ssl_cert/epoint.pswen.cn.cer --reloadcmd \"service nginx force-reload\"\n```\n\nnginx示例2：\n\n```sh\nacme.sh --install-cert -d chandao.test.com \\\n--key-file /usr/local/nginx/ssl_cert/test.com/chandao.test.com.key \\\n--fullchain-file /usr/local/nginx/ssl_cert/test.com/chandao.test.com.cer \\\n--reloadcmd      \"service nginx force-reload\"\n```\n\n附带完成前面1-4步骤的截图：\n\n![img](/p/4425fc35/867078-20190326175923357-720763416.png)\n\n5. Nginx服务器安装SSL证书\n\nNginx 配置Http和Https共存\n\n```shell\nlisten 80; #如果硬性要求全部走https协议，这一行去除\nlisten 443 ssl http2; #如果硬性要求全部走https协议，这里去除ssl\nserver_name chandao.test.com;\n\n#ssl on; #如果硬性要求全部走https协议，这里开启ssl on\nssl_certificate /usr/local/nginx/ssl_cert/test.com/chandao.test.com.cer;\nssl_certificate_key /usr/local/nginx/ssl_cert/test.com/chandao.test.com.key;\n\n#ssl性能调优\n#nginx 1.13.0支持了TLSv1.3,TLSv1.3相比之前的TLSv1.2、TLSv1.1等性能大幅提升\nssl_protocols TLSv1 TLSv1.1 TLSv1.2;\nssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;\nssl_prefer_server_ciphers on;\nssl_session_timeout 10m;\n#使用ssl_session_cache优化https下Nginx的性能\nssl_session_cache builtin:1000 shared:SSL:10m;\n#OCSP Stapling 开启。OCSP是用于在线查询证书吊销情况的服务，使用OCSP Stapling能将证书有效状态的信息缓存到服务器，提高 TLS 握手速度\nssl_stapling on;\n#OCSP Stapling 验证开启\nssl_stapling_verify on; \n```\n\n完整例子：\n\n```shell\nserver {\n  listen 80;  #如果硬性要求全部走https协议，这一行去除\n  listen       443 ssl http2;    #如果硬性要求全部走https协议，这里去除ssl\n  server_name chandao.test.com;\n  access_log off;\n  index index.html index.htm index.php;\n  root /data/wwwroot/chandao;\n\n  #ssl on;   #如果硬性要求全部走https协议，这里开启ssl on\n  ssl_certificate   /usr/local/nginx/ssl_cert/test.com/chandao.test.com.cer;\n  ssl_certificate_key  /usr/local/nginx/ssl_cert/test.com/chandao.test.com.key;\n\n  #ssl性能调优\n  #nginx 1.13.0支持了TLSv1.3,TLSv1.3相比之前的TLSv1.2、TLSv1.1等性能大幅提升\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n  ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;\n  ssl_prefer_server_ciphers on;\n  ssl_session_timeout 10m;\n  #使用ssl_session_cache优化https下Nginx的性能\n  ssl_session_cache builtin:1000 shared:SSL:10m;\n  #OCSP Stapling 开启。OCSP是用于在线查询证书吊销情况的服务，使用OCSP Stapling能将证书有效状态的信息缓存到服务器，提高 TLS 握手速度\n  ssl_stapling on;\n  #OCSP Stapling 验证开启\n  ssl_stapling_verify on; \n\n  #error_page 404 /404.html;\n  #error_page 502 /502.html;\n\n  location ~ [^/]\\.php(/|$) {\n    #fastcgi_pass remote_php_ip:9000;\n    fastcgi_pass unix:/dev/shm/php-cgi.sock;\n    fastcgi_index index.php;\n    include fastcgi.conf;\n  }\n\n  location ~ .*\\.(gif|jpg|jpeg|png|bmp|swf|flv|mp4|ico)$ {\n    expires 30d;\n    access_log off;\n  }\n  location ~ .*\\.(js|css)?$ {\n    expires 7d;\n    access_log off;\n  }\n  location ~ /\\.ht {\n    deny all;\n  }\n}\n```\n\n6.重启nginx\n保存退出后，通过nginx -t来检查配置文件是否正确，有错误的话改之即可。配置文件检测正确之后，通过service nginx force-reload来重载配置文件。\n\n```shell\nnginx -t\nsystemctl restart nginx\n```\n","more":"<html><head></head><body><p><strong>安装环境：</strong><br>\n<strong>操作系统：centos 7 X64</strong><br>\n<strong>SSL 证书来源：Let’s Encrypt</strong><br>\n<strong> 安装用脚本：<a href=\"http://acme.sh\">acme.sh</a></strong><br>\n<strong> 服务器：nginx</strong><br>\n<strong> 域名：<a href=\"http://epoint.pswen.cn\">epoint.pswen.cn</a></strong></p>\n<p><a href=\"http://1.xn--acme-ke9g492u.sh\">1. 安装 acme.sh</a></p>\n<figure class=\"highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://get.acme.sh | sh</span><br></pre></td></tr></tbody></table></figure>\n<p>2. 安装后的配置<br>\n把 <a href=\"http://acme.sh\">acme.sh</a> 安装到你的 home 目录下:~/.acme.sh/ 并创建 一个 bash 的 alias, 方便你的使用:</p>\n<figure class=\"highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alias acme.sh=~/.acme.sh/acme.sh</span><br><span class=\"line\">echo 'alias acme.sh=~/.acme.sh/acme.sh' &gt;&gt;/etc/profile</span><br></pre></td></tr></tbody></table></figure>\n<p>3. 申请证书<br>\n<a href=\"http://acme.sh\"> acme.sh</a> 实现了 acme 协议支持的所有验证协议。一般有两种方式验证: http 和 dns 验证（本文不提供 dns 方式申请，dns 手动模式，不能自动更新证书。在续订证书时，您必须手动向域中添加新的 txt 记录。）</p>\n<p>HTTP 方式方法如下：</p>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --issue -d epoint.pswen.cn --webroot /nginx网站根目录</span><br></pre></td></tr></tbody></table></figure>\n<p>只需要指定域名，并指定域名所在的网站根目录【命令中根目录路径】. <a href=\"http://acme.sh\">acme.sh</a> 会全自动的生成验证文件，并放到网站的根目录，然后自动完成验证。最后会聪明的删除验证文件。整个过程没有任何副作用.</p>\n<p>4. 证书的安装<br>\n注意，默认生成的证书都放在安装目录下: ~/.acme.sh/, 请不要直接使用此目录下的文件，<br>\n 例如：不要直接让 nginx/apache 的配置文件使用这下面的文件.<br>\n 这里面的文件都是内部使用，而且目录结构可能会变化.</p>\n<p>正确的使用方法是使用 --installcert 命令，并指定目标位置，然后证书文件会被 copy 到相应的位置，</p>\n<p>Nginx 服务： <code>service nginx force-reload</code> 。(centos6)</p>\n<p>Nginx 服务： <code>systemctl restart nginx </code> 。(centos7)</p>\n<p>nginx 示例 1:</p>\n<figure class=\"highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --installcert -d epoint.pswen.cn --key-file /usr/local/nginx/ssl_cert/epoint.pswen.cn.key --fullchain-file /usr/local/nginx/ssl_cert/epoint.pswen.cn.cer --reloadcmd \"service nginx force-reload\"</span><br></pre></td></tr></tbody></table></figure>\n<p>nginx 示例 2：</p>\n<figure class=\"highlight sh\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acme.sh --install-cert -d chandao.test.com \\</span><br><span class=\"line\">--key-file /usr/local/nginx/ssl_cert/test.com/chandao.test.com.key \\</span><br><span class=\"line\">--fullchain-file /usr/local/nginx/ssl_cert/test.com/chandao.test.com.cer \\</span><br><span class=\"line\">--reloadcmd      <span class=\"string\">\"service nginx force-reload\"</span></span><br></pre></td></tr></tbody></table></figure>\n<p>附带完成前面 1-4 步骤的截图：</p>\n<p><img src=\"/p/4425fc35/index.html867078-20190326175923357-720763416.png\" alt=\"img\"></p>\n<ol start=\"5\">\n<li>Nginx 服务器安装 SSL 证书</li>\n</ol>\n<p>Nginx 配置 Http 和 Https 共存</p>\n<figure class=\"highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">listen 80; #如果硬性要求全部走https协议，这一行去除</span><br><span class=\"line\">listen 443 ssl http2; #如果硬性要求全部走https协议，这里去除ssl</span><br><span class=\"line\">server_name chandao.test.com;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">ssl on; <span class=\"comment\">#如果硬性要求全部走https协议，这里开启ssl on</span></span></span><br><span class=\"line\">ssl_certificate /usr/local/nginx/ssl_cert/test.com/chandao.test.com.cer;</span><br><span class=\"line\">ssl_certificate_key /usr/local/nginx/ssl_cert/test.com/chandao.test.com.key;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">ssl性能调优</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">nginx 1.13.0支持了TLSv1.3,TLSv1.3相比之前的TLSv1.2、TLSv1.1等性能大幅提升</span></span><br><span class=\"line\">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;</span><br><span class=\"line\">ssl_prefer_server_ciphers on;</span><br><span class=\"line\">ssl_session_timeout 10m;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">使用ssl_session_cache优化https下Nginx的性能</span></span><br><span class=\"line\">ssl_session_cache builtin:1000 shared:SSL:10m;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">OCSP Stapling 开启。OCSP是用于在线查询证书吊销情况的服务，使用OCSP Stapling能将证书有效状态的信息缓存到服务器，提高 TLS 握手速度</span></span><br><span class=\"line\">ssl_stapling on;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">OCSP Stapling 验证开启</span></span><br><span class=\"line\">ssl_stapling_verify on; </span><br></pre></td></tr></tbody></table></figure>\n<p>完整例子：</p>\n<figure class=\"highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server {</span><br><span class=\"line\">  listen 80;  #如果硬性要求全部走https协议，这一行去除</span><br><span class=\"line\">  listen       443 ssl http2;    #如果硬性要求全部走https协议，这里去除ssl</span><br><span class=\"line\">  server_name chandao.test.com;</span><br><span class=\"line\">  access_log off;</span><br><span class=\"line\">  index index.html index.htm index.php;</span><br><span class=\"line\">  root /data/wwwroot/chandao;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">ssl on;   <span class=\"comment\">#如果硬性要求全部走https协议，这里开启ssl on</span></span></span><br><span class=\"line\">  ssl_certificate   /usr/local/nginx/ssl_cert/test.com/chandao.test.com.cer;</span><br><span class=\"line\">  ssl_certificate_key  /usr/local/nginx/ssl_cert/test.com/chandao.test.com.key;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">ssl性能调优</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">nginx 1.13.0支持了TLSv1.3,TLSv1.3相比之前的TLSv1.2、TLSv1.1等性能大幅提升</span></span><br><span class=\"line\">  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">  ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;</span><br><span class=\"line\">  ssl_prefer_server_ciphers on;</span><br><span class=\"line\">  ssl_session_timeout 10m;</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">使用ssl_session_cache优化https下Nginx的性能</span></span><br><span class=\"line\">  ssl_session_cache builtin:1000 shared:SSL:10m;</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">OCSP Stapling 开启。OCSP是用于在线查询证书吊销情况的服务，使用OCSP Stapling能将证书有效状态的信息缓存到服务器，提高 TLS 握手速度</span></span><br><span class=\"line\">  ssl_stapling on;</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">OCSP Stapling 验证开启</span></span><br><span class=\"line\">  ssl_stapling_verify on; </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">error_page 404 /404.html;</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">error_page 502 /502.html;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  location ~ [^/]\\.php(/|$) {</span><br><span class=\"line\">    #fastcgi_pass remote_php_ip:9000;</span><br><span class=\"line\">    fastcgi_pass unix:/dev/shm/php-cgi.sock;</span><br><span class=\"line\">    fastcgi_index index.php;</span><br><span class=\"line\">    include fastcgi.conf;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  location ~ .*\\.(gif|jpg|jpeg|png|bmp|swf|flv|mp4|ico)$ {</span><br><span class=\"line\">    expires 30d;</span><br><span class=\"line\">    access_log off;</span><br><span class=\"line\">  }</span><br><span class=\"line\">  location ~ .*\\.(js|css)?$ {</span><br><span class=\"line\">    expires 7d;</span><br><span class=\"line\">    access_log off;</span><br><span class=\"line\">  }</span><br><span class=\"line\">  location ~ /\\.ht {</span><br><span class=\"line\">    deny all;</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<p>6. 重启 nginx<br>\n 保存退出后，通过 nginx -t 来检查配置文件是否正确，有错误的话改之即可。配置文件检测正确之后，通过 service nginx force-reload 来重载配置文件。</p>\n<figure class=\"highlight shell\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -t</span><br><span class=\"line\">systemctl restart nginx</span><br></pre></td></tr></tbody></table></figure></body></html>","categories":[],"tags":[{"name":"linux","path":"api/tags/linux.json"},{"name":"acmesh","path":"api/tags/acmesh.json"},{"name":"域名证书","path":"api/tags/域名证书.json"}]}